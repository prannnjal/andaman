{% extends 'inquiries/base.html' %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<h1>Import Leads from Google Sheets</h1>
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-download"></i> Import Leads from Google Sheets
                    </h3>
                </div>
                <div class="card-body">
                    {% if error_message %}
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle"></i> {{ error_message }}
                        </div>
                    {% endif %}

                    {% if success_message %}
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle"></i> {{ success_message }}
                        </div>
                    {% endif %}

                    <form method="post" class="mb-4">
                        {% csrf_token %}
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="spreadsheet_id">Google Sheets ID *</label>
                                    <input type="text" class="form-control" id="spreadsheet_id" name="spreadsheet_id" 
                                           value="{% if request.GET.spreadsheet_id %}{{ request.GET.spreadsheet_id }}{% elif request.POST.spreadsheet_id %}{{ request.POST.spreadsheet_id }}{% endif %}"
                                           placeholder="e.g., 1BxiMVs0XRA5nFMdKvBdBZjgmUUqptlbs74OgvE2upms" required>
                                    <small class="form-text text-muted">
                                        Found in the URL: https://docs.google.com/spreadsheets/d/<strong>YOUR_SHEET_ID</strong>/edit
                                    </small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="range_name">Range *</label>
                                    <input type="text" class="form-control" id="range_name" name="range_name" 
                                           value="{% if request.GET.range_name %}{{ request.GET.range_name }}{% elif request.POST.range_name %}{{ request.POST.range_name }}{% endif %}"
                                           placeholder="e.g., Sheet1!A1:Z1000" required>
                                    <small class="form-text text-muted">
                                        Specify the sheet name and range (e.g., Sheet1!A1:Z1000)
                                    </small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="agent_id">
                                        <i class="fas fa-user-tie"></i> Assign to Agent (Optional)
                                    </label>
                                    <select class="form-control" id="agent_id" name="agent_id">
                                        <option value="">-- Auto-assign to agents with least workload --</option>
                                        {% for agent in available_agents %}
                                            <option value="{{ agent.id }}" {% if request.POST.agent_id == agent.id|stringformat:"s" %}selected{% endif %}>
                                                ðŸ‘¤ {{ agent.name }} ({{ agent.mobile_number }})
                                            </option>
                                        {% endfor %}
                                    </select>
                                    <small class="form-text text-muted">
                                        <strong>Auto-distribute:</strong> Leave empty to automatically distribute leads among agents<br>
                                        <strong>Direct assign:</strong> Select a specific agent to assign all leads to them
                                    </small>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="segment_select">Segment</label>
                                    <select class="form-control" id="segment_select" name="segment">
                                        <option value="cnb-leads" {% if request.POST.segment == 'cnb-leads' or not request.POST.segment %}selected{% endif %}>CNB Leads</option>
                                        <option value="schools" {% if request.POST.segment == 'schools' %}selected{% endif %}>Schools</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-8" id="school_select_wrapper" {% if request.POST.segment != 'schools' %}style="display:none"{% endif %}>
                                <div class="form-group">
                                    <label for="school_id">Select School (if Segment is Schools)</label>
                                    <select class="form-control" id="school_id" name="school_id">
                                        <option value="">-- Select School --</option>
                                        {% for s in schools %}
                                            <option value="{{ s.id }}" {% if request.POST.school_id == s.id|stringformat:"s" %}selected{% endif %}>{{ s.name }}</option>
                                        {% endfor %}
                                    </select>
                                    <small class="form-text text-muted">If you choose Schools segment and select a school, imported leads will be linked to that school.</small>
                                </div>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-download"></i> Import Leads
                        </button>
                    </form>

                    {% if import_result %}
                        <div class="import-results">
                            {% if import_result.success %}
                                <div class="alert alert-success">
                                    <h5><i class="fas fa-check-circle"></i> Import Successful</h5>
                                    <p><strong>{{ import_result.imported_count }}</strong> leads were successfully imported.</p>
                                    <p class="mb-0"><i class="fas fa-info-circle"></i> {{ import_result.message }}</p>
                                </div>
                            {% else %}
                                <div class="alert alert-warning">
                                    <h5><i class="fas fa-exclamation-triangle"></i> Import Completed with Issues</h5>
                                    <p><strong>{{ import_result.imported_count }}</strong> leads were imported.</p>
                                </div>
                            {% endif %}

                            {% if import_result.errors %}
                                <div class="alert alert-warning">
                                    <h5><i class="fas fa-exclamation-triangle"></i> Errors Found</h5>
                                    <p>The following errors occurred during import:</p>
                                    <ul class="error-list">
                                        {% for error in import_result.errors %}
                                            <li>{{ error }}</li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            {% endif %}
                        </div>
                    {% endif %}

                    <div class="alert alert-info">
                        <h5><i class="fas fa-info-circle"></i> Import Information</h5>
                        <ul>
                            <li><strong>Required Headers:</strong> student_name, parent_name, mobile_number, email, address, block, location_panchayat, inquiry_source, student_class</li>
                            <li><strong>Optional Headers:</strong> status, remarks, inquiry_date, registration_date, admission_test_date, admission_offered_date, admission_confirmed_date, rejected_date, follow_up_date</li>
                            <li>Duplicate leads (same mobile number and email) will be skipped</li>
                            <li><strong>Agent Assignment:</strong> 
                                <ul>
                                    <li><strong>No agent selected:</strong> Leads will be automatically distributed among agents with the least workload</li>
                                    <li><strong>Specific agent selected:</strong> All leads will be assigned directly to the selected agent</li>
                                </ul>
                            </li>
                            <li>Only admin users can perform imports</li>
                        </ul>
                    </div>

                    <div class="mt-4">
                        <a href="{% url 'google_sheets_preview' %}" class="btn btn-primary">
                            <i class="fas fa-eye"></i> Preview Data First
                        </a>
                        <a href="{% url 'google_sheets_setup' %}" class="btn btn-secondary">
                            <i class="fas fa-cog"></i> Setup Instructions
                        </a>
                        <a href="{% url 'inquiry_list' %}" class="btn btn-info">
                            <i class="fas fa-list"></i> View All Leads
                        </a>
                        <a href="{% url 'dashboard' %}" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left"></i> Back to Dashboard
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function(){
    const segmentSelect = document.getElementById('segment_select');
    const wrapper = document.getElementById('school_select_wrapper');
    if(segmentSelect && wrapper){
        segmentSelect.addEventListener('change', function(){
            wrapper.style.display = this.value === 'schools' ? '' : 'none';
        });
    }
});
// Auto-fill form fields from URL parameters if they exist
document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    const spreadsheetId = urlParams.get('spreadsheet_id');
    const rangeName = urlParams.get('range_name');
    
    if (spreadsheetId && !document.getElementById('spreadsheet_id').value) {
        document.getElementById('spreadsheet_id').value = spreadsheetId;
    }
    
    if (rangeName && !document.getElementById('range_name').value) {
        document.getElementById('range_name').value = rangeName;
    }
});
</script>
{% endblock %} 