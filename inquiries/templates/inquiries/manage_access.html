{% load tz %}  {# Load timezone template tags #}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grant/Revoke Access</title>
</head>

<style>
    body {
        font-family: Arial, sans-serif;
        background-color: #f4f4f4;
        margin: 0;
        padding: 20px;
    }
    
    .container {
        max-width: 1000px;
        margin: 0 auto;
        padding: 20px;
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }
    
    h1, h2 {
        text-align: center;
        margin-bottom: 30px;
    }
    
    table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 20px;
    }
    
    table th, table td {
        padding: 12px;
        text-align: center;
        border-bottom: 1px solid #ddd;
    }
    
    button {
        padding: 6px 12px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }
    
    button:hover {
        background-color: #0056b3;
    }
    
    input[type="radio"], select {
        margin-right: 10px;
    }
    
    .messages {
        margin-bottom: 20px;
    }
    
    .message {
        padding: 10px;
        margin-bottom: 10px;
        border-radius: 4px;
    }
    
    .message.success {
        background-color: #00d832;
        color: #ffffff;
    }
    
    .message.info {
        background-color: #e79a00;
        color: #ffffff;
    }
    
    .message.error {
        background-color: #fd0015;
        color: #ffffff;
    }    

    .navigation {
        text-align: center;
        margin-bottom: 30px;
      }
    
      .add_new_agent {
        background-color: #28a745;
        color: #fff !important;
        padding: 10px 20px;
        border-radius: 5px;
        text-decoration: none;
        font-weight: 600;
        display: inline-block;
      }

      #opaque-background {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
    }

    .messages {
        position: fixed;  /* Or use 'fixed' or 'absolute' depending on your layout */
        z-index: 1100;        /* Higher than 1000 */
        margin-bottom: 20px; 
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        width: 98%;
        text-align: center;
    }
    

    #manage-access-container {
        background: #fff;
        width: 400px;
        margin: 100px auto;
        padding: 20px;
        border-radius: 8px;
        position: relative;
    }

    #manage-access-container h2 {
        margin-top: 0;
    }

    #close-modal {
        position: absolute;
        top: 10px;
        right: 10px;
        cursor: pointer;
        font-weight: bold;
    }

    button:disabled {
        cursor: not-allowed;
        opacity: 0.5; /* Optional: To visually indicate that the button is disabled */
    }

    #manage-access-container {
        background: #fff;
        width: 600px; /* Increased width */
        max-height: 90vh; /* Allow some scroll if needed */
        margin: 50px auto;
        padding: 30px;
        border-radius: 10px;
        position: relative;
        overflow-y: auto;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        font-family: Arial, sans-serif;
    }
    
    #manage-access-container h2 {
        margin-top: 0;
        margin-bottom: 20px;
        text-align: center;
        font-size: 24px;
        color: #333;
    }
    
    #close-modal {
        position: absolute;
        top: 10px;
        right: 15px;
        font-size: 18px;
        color: #888;
        cursor: pointer;
    }
    
    #manage-access-container form {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }
    
    #manage-access-container label {
        font-weight: bold;
        margin-bottom: 4px;
        color: #444;
    }
    
    #manage-access-container input,
    #manage-access-container select {
        padding: 10px;
        border-radius: 5px;
        border: 1px solid #ccc;
        width: 100%;
        box-sizing: border-box;
    }
    
    #manage-access-container button[type="submit"] {
        margin-top: 10px;
        background-color: #007bff;
        color: #fff;
        padding: 10px;
        font-weight: bold;
        border: none;
        border-radius: 5px;
        cursor: pointer;
    }
    
    #manage-access-container button[type="submit"]:hover {
        background-color: #0056b3;
    }

    .table-wrapper {
        max-width: 80vw;
        max-height: 50vh;
        overflow: auto;
        margin: 0 auto; /* Center it horizontally */
        border: 1px solid #ccc;
        border-radius: 8px;
        background-color: #fff;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
    }

    th {        
        position: sticky;
        top: 0;
        background-color: #f4f4f4; /* Light background color for sticky headers */
        z-index: 1; /* Ensures headers appear above the table body */      
        padding: 12px;
        font-weight: bold;
        border-bottom: 2px solid #ddd;
        text-align: center;
    }

    .same_row_wrapper {
        display: flex;
        flex-direction: row;          
        gap: 20px;
        align-items: center; 
        justify-content: center;         
    }
    
    
    
</style>


{% if form.is_bound or request.GET.edit_user_id %}
    <style>
        #opaque-background {
            display: block;
        }
    </style>
{% else %}
    <style>
        #opaque-background {
            display: none;
        }
    </style>
{% endif %}



<body>
    <div class="container">        
        <!-- Display messages -->
        {% if messages %}
            <div class="messages">
                {% for message in messages %}
                    <div class="message {{ message.tags }}">{{ message }}</div>
                {% endfor %}
            </div>
        {% endif %}

        <h1>Manage Users</h1>
        <h2>Grant / Revoke Access for Users</h2>
        
        <div class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th>Id</th>
                        <th style="min-width: 200px;">Name</th>
                        <th>Actions</th>
                        <th>Phone Number</th>                       
                        <th style="min-width: 200px;">Email</th>
                        <th>Role</th>                        
                        <th style="min-width: 200px;">Expire by</th>                        
                    </tr>
                </thead>
                <tbody>
                    {% for user in users %}
                        <tr>
                            <td>{{ user.id }}</td>
                            <td>{{ user.name }}</td>
                            <td>
                                <div class="same_row_wrapper">
                                    <!-- Edit User form -->
                                    <form method="get" style="display:inline;">
                                        <input type="hidden" name="edit_user_id" value="{{ user.id }}">
                                        {% if user.id == request.user.id or user.is_superuser %}
                                            <button type="submit" style="white-space: nowrap; width: auto; padding: 10px 12px; background-color: rgb(144, 144, 144);" disabled>Edit User</button>
                                        {% else %}
                                            <button style="white-space: nowrap; width: auto; padding: 10px 12px; " type="submit">Edit User</button>
                                        {% endif %}
        
                                    </form>
        
                                    <!-- Delete User form -->
                                    <form method="post" style="display:inline;">
                                        {% csrf_token %}
                                        <input type="hidden" name="action_type" value="delete">
                                        <input type="hidden" name="user_id" value="{{ user.id }}">
        
                                        {% if user.id == request.user.id or user.is_superuser %}
                                            <button type="submit" style="white-space: nowrap; width: auto; padding: 10px 12px; background-color: rgb(144, 144, 144);" disabled>Delete User</button>
                                        {% else %}
                                            <button type="submit" style="background-color: red; white-space: nowrap; width: auto; padding: 10px 12px;">Delete User</button>
                                        {% endif %}                               
                                    </form>
                                </div>
                            </td>
                            
                            <td>{{ user.mobile_number }}</td>                     
                            <td>{{ user.email }}</td>                     
                            <td>{{ user.role }}</td>                           
                            <td>                                
                                {% if user.expiration_time < now %}
                                    Expired on: {{ user.expiration_time }}
                                {% else %}
                                    {{ user.expiration_time }}
                                {% endif %}
                                </td>
                                        
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="same_row_wrapper">
            <div class="navigation">
                <a href="{% url 'dashboard' %}" class="add_new_agent" style="background-color: rgb(29, 186, 23);">Back to Dashboard</a>
            </div>
    
            <div class="navigation">
                <a href="{% url 'add_user' %}" class="add_new_agent" style="background-color: rgb(0, 76, 255);">Add new User</a>
            </div>
        </div>

        <!-- Hidden Modal to display Edit User form -->
        <div id="opaque-background">
            <div id="manage-access-container">
                <span id="close-modal" style="cursor:pointer;">âœ–</span>
                <h2>Edit User Access</h2>
                <form method="post">
                    {% csrf_token %}
                    <input type="hidden" name="action_type" value="update">
                    <input type="hidden" name="user_id" value="{{ request.GET.edit_user_id }}">
                    {{ form.name.label_tag }} {{ form.name }}
                    {{ form.mobile_number.label_tag }} {{ form.mobile_number }}
                    {{ form.email.label_tag }} {{ form.email }}
                    {{ form.role.label_tag }} {{ form.role }}
                    <label for="{{ form.expiration_time.id_for_label }}">Expiration Time:</label>
                    {{ form.expiration_time }}
                    <button type="submit">Save</button>
                </form>                
            </div>
        </div>
    </div>
</body>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Auto-hide flash messages
        const messagesContainer = document.querySelector('.messages');
        if (messagesContainer) {
            setTimeout(() => {
                messagesContainer.style.opacity = '0';
                setTimeout(() => messagesContainer.remove(), 500);
            }, 4000);
        }

        // Close modal on close button click
        document.getElementById('close-modal').addEventListener('click', function () {
            document.getElementById('opaque-background').style.display = 'none';
            window.location.href = "{% url 'manage_access' %}";
        });

        // Close modal when clicking outside the modal (on the overlay)
        const background = document.getElementById('opaque-background');
        const modal = document.getElementById('manage-access-container');

        background.addEventListener('click', function (e) {
            if (!modal.contains(e.target)) {
                background.style.display = 'none';
                window.location.href = "{% url 'manage_access' %}";
            }
        });
    });
</script>



</html>