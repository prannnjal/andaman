{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Preview Proposal</title>
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', Arial, sans-serif;
            background: linear-gradient(120deg, #f8fafc 0%, #e0e7ff 100%);
            min-height: 100vh;
        }
        .card {
            border-radius: 1rem;
            box-shadow: 0 4px 20px rgba(99, 102, 241, 0.1);
            border: none;
        }
        .card-header {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            border-radius: 1rem 1rem 0 0 !important;
            padding: 1.5rem;
        }
        .btn-preview {
            border-radius: 0.5rem;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            transition: all 0.3s ease;
        }
        .btn-preview:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .lead-info {
            background: #f8f9fa;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }
        .lead-info h6 {
            color: #6366f1;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        .form-control:focus {
            border-color: #6366f1;
            box-shadow: 0 0 0 0.2rem rgba(99, 102, 241, 0.25);
        }
        .preview-container {
            background: #fff;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-top: 1rem;
            border: 2px dashed #6366f1;
        }
        .preview-iframe {
            width: 100%;
            min-height: 600px;
            border: 1px solid #ddd;
            border-radius: 0.5rem;
            background: #f8f9fa;
        }
        .action-buttons {
            position: sticky;
            bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-top: 1px solid #eee;
            padding: 1rem 0;
            margin-top: 2rem;
        }
    </style>
</head>
<body>
    <div class="container py-4">
        {% include "inquiries/Modal.html" %}
        {% include "inquiries/Alerts.html" %}
        
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <div class="card">
                    <div class="card-header text-center">
                        <h3 class="mb-0">
                            <i class="fas fa-eye me-2"></i>
                            Preview Proposal
                        </h3>
                    </div>
                    <div class="card-body p-4">
                        <!-- Lead Information -->
                        <div class="lead-info">
                            <h6><i class="fas fa-user me-2"></i>Lead Information</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <strong>Student:</strong> {{ inquiry.student_name }}<br>
                                    <strong>Parent:</strong> {{ inquiry.parent_name }}<br>
                                    <strong>Class:</strong> {{ inquiry.student_class }}
                                </div>
                                <div class="col-md-6">
                                    <strong>Email:</strong> 
                                    {% if inquiry.email %}
                                        <span class="text-success">{{ inquiry.email }}</span>
                                    {% else %}
                                        <span class="text-danger">Not available</span>
                                    {% endif %}<br>
                                    <strong>Mobile:</strong> 
                                    {% if inquiry.mobile_number %}
                                        <span class="text-success">{{ inquiry.mobile_number }}</span>
                                    {% else %}
                                        <span class="text-danger">Not available</span>
                                    {% endif %}<br>
                                    <strong>Source:</strong> {{ inquiry.inquiry_source }}
                                </div>
                            </div>
                        </div>

                        <!-- Preview Form -->
                        <form method="post" id="previewForm">
                            {% csrf_token %}
                            
                            <!-- Custom Message -->
                            <div class="mb-4">
                                <label for="custom_message" class="form-label fw-semibold">
                                    <i class="fas fa-comment me-2"></i>Custom Message (Optional)
                                </label>
                                <textarea class="form-control" id="custom_message" name="custom_message" rows="4" 
                                          placeholder="Add a personalized message to include in the proposal..." 
                                          oninput="updateRealtimePreview()"></textarea>
                                <small class="text-muted">Type your message above to see real-time preview below</small>
                            </div>

                            <!-- Preview Buttons -->
                            <div class="text-center mb-4">
                                <button type="button" class="btn btn-primary btn-preview me-2" onclick="generatePDFPreview()">
                                    <i class="fas fa-file-pdf me-2"></i>Generate PDF
                                </button>
                                <button type="button" class="btn btn-info btn-preview me-2" onclick="togglePreviewMode()">
                                    <i class="fas fa-eye me-2"></i>Toggle Preview Mode
                                </button>
                                <button type="button" class="btn btn-secondary btn-preview" onclick="testPreview()">
                                    <i class="fas fa-test me-2"></i>Test Preview
                                </button>
                            </div>
                        </form>

                        <!-- Real-time Preview Container -->
                        <div class="preview-container" id="realtimePreviewContainer">
                            <h6 class="text-center mb-3">
                                <i class="fas fa-eye me-2"></i>Real-time Preview
                            </h6>
                            <div id="realtimePreview" class="preview-iframe" style="background: white; padding: 20px; overflow-y: auto;">
                                <div class="text-center p-4">
                                    <i class="fas fa-spinner fa-spin fa-2x text-primary"></i>
                                    <br><br>
                                    <p>Loading real-time preview...</p>
                                </div>
                            </div>
                        </div>

                        <!-- PDF Preview Container -->
                        <div class="preview-container" id="pdfPreviewContainer" style="display: none;">
                            <h6 class="text-center mb-3">
                                <i class="fas fa-file-pdf me-2"></i>PDF Preview
                            </h6>
                            <div id="pdfPreview" class="preview-iframe">
                                <div class="text-center p-4">
                                    <i class="fas fa-spinner fa-spin fa-2x text-primary"></i>
                                    <br><br>
                                    <p>Loading PDF preview...</p>
                                </div>
                            </div>
                            <div class="text-center mt-3">
                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="openPreviewInNewTab()">
                                    <i class="fas fa-external-link-alt me-1"></i>Open in New Tab
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-success" onclick="downloadPreview()">
                                    <i class="fas fa-download me-1"></i>Download PDF
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-info" onclick="refreshPreview()">
                                    <i class="fas fa-redo me-1"></i>Refresh Preview
                                </button>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="action-buttons">
                            <div class="d-flex justify-content-between align-items-center">
                                <a href="{% url 'inquiry_list' %}" class="btn btn-secondary btn-preview">
                                    <i class="fas fa-arrow-left me-2"></i>Back to List
                                </a>
                                
                                <div>
                                    <a href="{% url 'send_proposal' inquiry.id %}" class="btn btn-success btn-preview me-2">
                                        <i class="fas fa-paper-plane me-2"></i>Send Proposal
                                    </a>
                                    <button type="button" class="btn btn-info btn-preview" onclick="downloadPreview()">
                                        <i class="fas fa-download me-2"></i>Download PDF
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
         <script>
         let currentPdfUrl = '';
         let previewUpdateTimer = null;
         
         // Real-time preview update function
         function updateRealtimePreview() {
             const customMessage = $('#custom_message').val();
             
             // Clear previous timer
             if (previewUpdateTimer) {
                 clearTimeout(previewUpdateTimer);
             }
             
             // Set new timer to update preview after user stops typing
             previewUpdateTimer = setTimeout(function() {
                 generateDirectHTMLPreview(customMessage);
             }, 300); // Wait 300ms after user stops typing
         }
         
         // Generate direct HTML preview without server requests
         function generateDirectHTMLPreview(customMessage) {
             const currentDate = new Date().toLocaleDateString('en-US', { 
                 year: 'numeric', 
                 month: 'long', 
                 day: 'numeric' 
             });
             
             // Calculate fees based on class
             const feeStructure = {
                 'Play School': 3000, 'Nursery': 3500, 'LKG': 4000, 'UKG': 4500,
                 'Grade 1': 5000, 'Grade 2': 5500, 'Grade 3': 6000, 'Grade 4': 6500,
                 'Grade 5': 7000, 'Grade 6': 7500, 'Grade 7': 8000, 'Grade 8': 8500,
                 'Grade 9': 9000, 'Grade 10': 9500, 'Grade 11': 10000, 'Grade 12': 10500,
             };
             const baseFee = feeStructure['{{ inquiry.student_class }}'] || 5000;
             
             // Generate HTML preview directly
             const htmlContent = `
                 <div style="font-family: Arial, sans-serif; line-height: 1.6; max-width: 800px; margin: 0 auto;">
                     <div style="text-align: center; margin-bottom: 30px;">
                         <div style="color: #6366f1; font-size: 24px; margin-bottom: 10px; font-weight: bold;">Educational Proposal for {{ inquiry.student_name }}</div>
                         <div style="color: #666;">Date: ${currentDate}</div>
                     </div>
                     
                     <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 30px;">
                         <strong>Your Educational Institution</strong><br>
                         Your Institution Address, City, State - PIN<br>
                         Phone: +91-XXXXXXXXXX | Email: info@yourinstitution.com<br>
                         Website: www.yourinstitution.com
                     </div>
                     
                     <div style="margin-bottom: 25px;">
                         <div style="color: #4f46e5; font-size: 18px; margin-bottom: 15px; border-bottom: 2px solid #6366f1; padding-bottom: 5px; font-weight: bold;">Student Information</div>
                         <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                             <tr><td style="padding: 8px; border: 1px solid #ddd; background: #f3f4f6; font-weight: bold; width: 30%;">Student Name</td><td style="padding: 8px; border: 1px solid #ddd;">{{ inquiry.student_name }}</td></tr>
                             <tr><td style="padding: 8px; border: 1px solid #ddd; background: #f3f4f6; font-weight: bold;">Class</td><td style="padding: 8px; border: 1px solid #ddd;">{{ inquiry.student_class }}</td></tr>
                             <tr><td style="padding: 8px; border: 1px solid #ddd; background: #f3f4f6; font-weight: bold;">Parent Name</td><td style="padding: 8px; border: 1px solid #ddd;">{{ inquiry.parent_name }}</td></tr>
                             <tr><td style="padding: 8px; border: 1px solid #ddd; background: #f3f4f6; font-weight: bold;">Contact Number</td><td style="padding: 8px; border: 1px solid #ddd;">{{ inquiry.mobile_number|default:"Not provided" }}</td></tr>
                             <tr><td style="padding: 8px; border: 1px solid #ddd; background: #f3f4f6; font-weight: bold;">Email Address</td><td style="padding: 8px; border: 1px solid #ddd;">{{ inquiry.email|default:"Not provided" }}</td></tr>
                             <tr><td style="padding: 8px; border: 1px solid #ddd; background: #f3f4f6; font-weight: bold;">Address</td><td style="padding: 8px; border: 1px solid #ddd;">{{ inquiry.address|default:"Not provided" }}</td></tr>
                             <tr><td style="padding: 8px; border: 1px solid #ddd; background: #f3f4f6; font-weight: bold;">Inquiry Source</td><td style="padding: 8px; border: 1px solid #ddd;">{{ inquiry.inquiry_source }}</td></tr>
                         </table>
                     </div>
                     
                     ${customMessage ? `<div style="background: #fef3c7; padding: 15px; border-left: 4px solid #f59e0b; margin: 20px 0;"><strong>Personal Message:</strong><br>${customMessage}</div>` : ''}
                     
                     <div style="margin-bottom: 25px;">
                         <div style="color: #4f46e5; font-size: 18px; margin-bottom: 15px; border-bottom: 2px solid #6366f1; padding-bottom: 5px; font-weight: bold;">Our Educational Services</div>
                         <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                             <tr style="background: #6366f1; color: white;">
                                 <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">Service</th>
                                 <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">Description</th>
                                 <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">Benefits</th>
                             </tr>
                             <tr><td style="padding: 10px; border: 1px solid #ddd;">Academic Excellence</td><td style="padding: 10px; border: 1px solid #ddd;">Comprehensive curriculum designed for holistic development</td><td style="padding: 10px; border: 1px solid #ddd;">Strong foundation for future success</td></tr>
                             <tr><td style="padding: 10px; border: 1px solid #ddd;">Experienced Faculty</td><td style="padding: 10px; border: 1px solid #ddd;">Qualified and experienced teachers</td><td style="padding: 10px; border: 1px solid #ddd;">Quality education and mentorship</td></tr>
                             <tr><td style="padding: 10px; border: 1px solid #ddd;">Modern Infrastructure</td><td style="padding: 10px; border: 1px solid #ddd;">State-of-the-art facilities and technology</td><td style="padding: 10px; border: 1px solid #ddd;">Enhanced learning experience</td></tr>
                             <tr><td style="padding: 10px; border: 1px solid #ddd;">Individual Attention</td><td style="padding: 10px; border: 1px solid #ddd;">Personalized attention to each student</td><td style="padding: 10px; border: 1px solid #ddd;">Better understanding and growth</td></tr>
                             <tr><td style="padding: 10px; border: 1px solid #ddd;">Extracurricular Activities</td><td style="padding: 10px; border: 1px solid #ddd;">Sports, arts, and cultural programs</td><td style="padding: 10px; border: 1px solid #ddd;">Overall personality development</td></tr>
                             <tr><td style="padding: 10px; border: 1px solid #ddd;">Career Guidance</td><td style="padding: 10px; border: 1px solid #ddd;">Professional career counseling and guidance</td><td style="padding: 10px; border: 1px solid #ddd;">Clear career path and goals</td></tr>
                         </table>
                     </div>
                     
                     <div style="margin-bottom: 25px;">
                         <div style="color: #4f46e5; font-size: 18px; margin-bottom: 15px; border-bottom: 2px solid #6366f1; padding-bottom: 5px; font-weight: bold;">Investment Details</div>
                         <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                             <tr style="background: #059669; color: white;">
                                 <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">Fee Component</th>
                                 <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">Amount (₹)</th>
                                 <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">Description</th>
                             </tr>
                             <tr><td style="padding: 10px; border: 1px solid #ddd;">Tuition Fee</td><td style="padding: 10px; border: 1px solid #ddd;">₹${baseFee.toLocaleString()}</td><td style="padding: 10px; border: 1px solid #ddd;">Monthly tuition fee</td></tr>
                             <tr><td style="padding: 10px; border: 1px solid #ddd;">Admission Fee</td><td style="padding: 10px; border: 1px solid #ddd;">₹5,000</td><td style="padding: 10px; border: 1px solid #ddd;">One-time admission fee</td></tr>
                             <tr><td style="padding: 10px; border: 1px solid #ddd;">Development Fee</td><td style="padding: 10px; border: 1px solid #ddd;">₹2,000</td><td style="padding: 10px; border: 1px solid #ddd;">Annual development fee</td></tr>
                             <tr><td style="padding: 10px; border: 1px solid #ddd;">Transportation</td><td style="padding: 10px; border: 1px solid #ddd;">₹1,500</td><td style="padding: 10px; border: 1px solid #ddd;">Monthly transportation (optional)</td></tr>
                             <tr style="background: #fef3c7; font-weight: bold;"><td style="padding: 10px; border: 1px solid #ddd;">Total Monthly</td><td style="padding: 10px; border: 1px solid #ddd;">₹${(baseFee + 1500).toLocaleString()}</td><td style="padding: 10px; border: 1px solid #ddd;">Including transportation</td></tr>
                             <tr style="background: #fef3c7; font-weight: bold;"><td style="padding: 10px; border: 1px solid #ddd;">Total Annual</td><td style="padding: 10px; border: 1px solid #ddd;">₹${((baseFee + 1500) * 12 + 7000).toLocaleString()}</td><td style="padding: 10px; border: 1px solid #ddd;">Including all fees</td></tr>
                         </table>
                     </div>
                     
                     <div style="margin-bottom: 25px;">
                         <div style="color: #4f46e5; font-size: 18px; margin-bottom: 15px; border-bottom: 2px solid #6366f1; padding-bottom: 5px; font-weight: bold;">Terms & Conditions</div>
                         <ul style="margin-left: 20px;">
                             <li>Fees are payable monthly in advance by the 5th of each month</li>
                             <li>Late payment may incur additional charges</li>
                             <li>30 days notice is required for withdrawal</li>
                             <li>The institution reserves the right to modify fee structure with prior notice</li>
                             <li>All disputes are subject to local jurisdiction</li>
                             <li>This proposal is valid for 30 days from the date of issue</li>
                         </ul>
                     </div>
                     
                     <div style="text-align: center; margin-top: 40px; color: #6b7280; font-size: 14px;">
                         Thank you for considering our educational services. We look forward to partnering in your child's educational journey.
                     </div>
                 </div>
             `;
             
             $('#realtimePreview').html(htmlContent);
         }
         
         // Generate PDF preview
         function generatePDFPreview() {
             const customMessage = $('#custom_message').val();
             
             // Show loading state
             $('#pdfPreviewContainer').show();
             $('#pdfPreview').html('<div class="text-center p-4"><i class="fas fa-spinner fa-spin fa-2x text-primary"></i><br><p>Generating PDF preview...</p></div>');
             
             // Generate preview URL
             const previewUrl = `{% url 'preview_proposal' inquiry.id %}?custom_message=${encodeURIComponent(customMessage)}`;
             currentPdfUrl = previewUrl;
             
             // Simple iframe approach
             const iframeHtml = `<iframe src="${previewUrl}" style="width: 100%; height: 600px; border: 1px solid #ddd; border-radius: 0.5rem;" onload="console.log('PDF preview loaded')" onerror="handlePreviewError()"></iframe>`;
             $('#pdfPreview').html(iframeHtml);
             
             // Scroll to preview
             $('html, body').animate({
                 scrollTop: $('#pdfPreviewContainer').offset().top - 100
             }, 500);
         }
         
         // Toggle between real-time and PDF preview modes
         function togglePreviewMode() {
             const realtimeContainer = $('#realtimePreviewContainer');
             const pdfContainer = $('#pdfPreviewContainer');
             
             if (realtimeContainer.is(':visible')) {
                 realtimeContainer.hide();
                 pdfContainer.show();
                 generatePDFPreview();
             } else {
                 pdfContainer.hide();
                 realtimeContainer.show();
                 updateRealtimePreview();
             }
         }
         
         // Handle preview error
         function handlePreviewError() {
             $('#pdfPreview').html('<div class="text-center p-4 text-danger"><i class="fas fa-exclamation-triangle fa-2x"></i><br><p>Error loading preview. Please try the "Open in New Tab" option.</p></div>');
         }
         
         // Download preview PDF
         function downloadPreview() {
             if (currentPdfUrl) {
                 // Add download parameter to the URL
                 const downloadUrl = currentPdfUrl + '&download=true';
                 window.open(downloadUrl, '_blank');
             } else {
                 alert('Please generate a preview first.');
             }
         }
         
         // Test preview function
         function testPreview() {
             $('#pdfPreviewContainer').show();
             $('#pdfPreview').html('<div class="text-center p-4"><i class="fas fa-spinner fa-spin fa-2x"></i><br>Testing preview...</div>');
             
             // Test with a simple message
             const testUrl = `{% url 'preview_proposal' inquiry.id %}?custom_message=Test message`;
             $('#pdfPreview').attr('src', testUrl);
             
             console.log('Testing preview with URL:', testUrl);
         }
         
         // Open preview in new tab
         function openPreviewInNewTab() {
             if (currentPdfUrl) {
                 window.open(currentPdfUrl, '_blank');
             } else {
                 alert('Please generate a preview first.');
             }
         }

         // Refresh preview iframe
         function refreshPreview() {
             if (currentPdfUrl) {
                 $('#pdfPreview').attr('src', currentPdfUrl);
             } else {
                 alert('No preview URL available to refresh.');
             }
         }
         
         // Auto-generate preview on page load
         $(document).ready(function() {
             // Generate initial real-time preview
             updateRealtimePreview();
         });
     </script>
</body>
</html>
