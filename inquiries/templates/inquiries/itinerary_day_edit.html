{% extends "inquiries/modern_base.html" %}

{% block title %}Edit Day {{ day.day_number }} - {{ day.title }} | Travel CRM{% endblock %}

{% block extra_css %}
<style>
    .page-header {
        text-align: center;
        margin-bottom: var(--spacing-xl);
    }
    
    .page-title {
        font-size: 2.2rem;
        font-weight: 800;
        color: white;
        margin-bottom: var(--spacing-sm);
        text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
    }
    
    .day-info-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: var(--radius-lg);
        padding: var(--spacing-lg);
        margin-bottom: var(--spacing-xl);
        box-shadow: var(--shadow-lg);
    }
    
    .form-section {
        background: white;
        border-radius: var(--radius-lg);
        padding: var(--spacing-xl);
        margin-bottom: var(--spacing-lg);
        box-shadow: var(--shadow-lg);
    }
    
    .section-title {
        font-size: 1.3rem;
        font-weight: 700;
        color: var(--primary);
        margin-bottom: var(--spacing-lg);
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        padding-bottom: var(--spacing-sm);
        border-bottom: 2px solid var(--light);
    }
    
    .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: var(--spacing-lg);
    }
    
    .form-grid-2 {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: var(--spacing-lg);
    }
    
    .form-grid-3 {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: var(--spacing-lg);
    }
    
    @media (max-width: 768px) {
        .form-grid, .form-grid-2, .form-grid-3 {
            grid-template-columns: 1fr;
        }
    }
    
    .modern-form-group {
        margin-bottom: var(--spacing-lg);
    }
    
    .modern-label {
        display: block;
        font-weight: 600;
        margin-bottom: var(--spacing-sm);
        color: var(--dark);
        font-size: 0.95rem;
    }
    
    .modern-label i {
        color: var(--primary);
        margin-right: var(--spacing-xs);
    }
    
    .modern-input, .modern-select, .modern-textarea {
        width: 100%;
        padding: var(--spacing-sm) var(--spacing-md);
        border: 2px solid #e0e0e0;
        border-radius: var(--radius-sm);
        font-size: 1rem;
        transition: all 0.3s ease;
        font-family: 'Inter', sans-serif;
    }
    
    .modern-input:focus, .modern-select:focus, .modern-textarea:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(30, 136, 229, 0.1);
    }
    
    .modern-textarea {
        min-height: 100px;
        resize: vertical;
    }
    
    .required {
        color: var(--danger);
        margin-left: 2px;
    }
    
    .helper-text {
        font-size: 0.85rem;
        color: #666;
        margin-top: var(--spacing-xs);
    }
    
    .checkbox-group {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        margin-top: var(--spacing-sm);
    }
    
    .checkbox-group input[type="checkbox"] {
        transform: scale(1.2);
    }
    
    .cost-summary {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: var(--radius-md);
        padding: var(--spacing-lg);
        margin-top: var(--spacing-lg);
        border-left: 4px solid var(--success);
    }
    
    .cost-item {
        display: flex;
        justify-content: space-between;
        margin-bottom: var(--spacing-sm);
    }
    
    .cost-total {
        font-weight: 700;
        font-size: 1.1rem;
        border-top: 2px solid var(--success);
        padding-top: var(--spacing-sm);
        margin-top: var(--spacing-sm);
    }
    
    .submit-section {
        text-align: center;
        margin-top: var(--spacing-xl);
    }
    
    .btn-submit-modern {
        padding: var(--spacing-md) var(--spacing-xl);
        font-size: 1.1rem;
        font-weight: 700;
        border-radius: var(--radius-md);
        border: none;
        background: linear-gradient(135deg, var(--success) 0%, #4CAF50 100%);
        color: white;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: var(--shadow-md);
        min-width: 200px;
    }
    
    .btn-submit-modern:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
        background: linear-gradient(135deg, #4CAF50 0%, #388E3C 100%);
    }
    
    .hotel-availability {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: var(--radius-sm);
        padding: var(--spacing-sm);
        margin-top: var(--spacing-sm);
        font-size: 0.9rem;
    }
    
    .hotel-booked {
        background: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
    }
    
    .hotel-conflict {
        background: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">
        <i class="bi bi-calendar-day"></i> Edit Day {{ day.day_number }}
    </h1>
    <p class="page-subtitle" style="color: rgba(255,255,255,0.9);">
        Customize itinerary details for {{ day.title }}
    </p>
</div>

<!-- Day Information -->
<div class="day-info-card">
    <h3 style="margin-bottom: var(--spacing-md);">
        <i class="bi bi-info-circle"></i> Day Information
    </h3>
    <div class="form-grid">
        <div>
            <strong>Title:</strong> {{ day.title }}
        </div>
        <div>
            <strong>Description:</strong> {{ day.description|truncatechars:50 }}
        </div>
        <div>
            <strong>Itinerary:</strong> {{ day.itinerary.lead.customer_name }}
        </div>
        <div>
            <strong>Total PAX:</strong> {{ day.itinerary.pax }} travelers
        </div>
    </div>
</div>

<form method="POST" action="{% url 'itinerary_day_update' day.id %}">
    {% csrf_token %}
    
    <!-- Date Selection -->
    <div class="form-section">
        <div class="section-title">
            <i class="bi bi-calendar-range"></i>
            Date Selection
        </div>
        
        <div class="form-grid-3">
            <div class="modern-form-group">
                <label class="modern-label">
                    <i class="bi bi-calendar-event"></i>
                    Travel Date
                </label>
                <input type="date" name="travel_date" class="modern-input" value="{{ day.travel_date|date:'Y-m-d' }}">
                <p class="helper-text">Actual date for this travel day</p>
            </div>
            
            <div class="modern-form-group">
                <label class="modern-label">
                    <i class="bi bi-door-open"></i>
                    Check-in Date
                </label>
                <input type="date" name="check_in_date" class="modern-input" value="{{ day.check_in_date|date:'Y-m-d' }}">
                <p class="helper-text">Hotel check-in date</p>
            </div>
            
            <div class="modern-form-group">
                <label class="modern-label">
                    <i class="bi bi-door-closed"></i>
                    Check-out Date
                </label>
                <input type="date" name="check_out_date" class="modern-input" value="{{ day.check_out_date|date:'Y-m-d' }}">
                <p class="helper-text">Hotel check-out date</p>
            </div>
        </div>
    </div>
    
    <!-- Hotel Selection -->
    <div class="form-section">
        <div class="section-title">
            <i class="bi bi-building"></i>
            Hotel Selection & Booking
        </div>
        
        <div class="form-grid-2">
            <div class="modern-form-group">
                <label class="modern-label">
                    <i class="bi bi-building"></i>
                    Select Hotel
                </label>
                <select name="hotel" class="modern-select" id="hotel-select">
                    <option value="">Choose Hotel</option>
                    {% for hotel in hotels %}
                    <option value="{{ hotel.id }}" {% if day.hotel.id == hotel.id %}selected{% endif %}>
                        {{ hotel.name }} - {{ hotel.city }}
                    </option>
                    {% endfor %}
                </select>
                <p class="helper-text">Select a hotel for this day</p>
            </div>
            
            <div class="modern-form-group">
                <label class="modern-label">
                    <i class="bi bi-door-open-fill"></i>
                    Room Category
                </label>
                <select name="room_category" class="modern-select" id="room-category-select">
                    <option value="">Choose Room Category</option>
                    <!-- Room categories will be populated via JavaScript -->
                </select>
                <p class="helper-text">Select room type</p>
            </div>
        </div>
        
        <div class="form-grid-3">
            <div class="modern-form-group">
                <label class="modern-label">
                    <i class="bi bi-door-open"></i>
                    Number of Rooms
                </label>
                <input type="number" name="number_of_rooms" class="modern-input" value="{{ day.number_of_rooms }}" min="1" max="10">
                <p class="helper-text">Total rooms needed</p>
            </div>
            
            <div class="modern-form-group">
                <label class="modern-label">
                    <i class="bi bi-plus-circle"></i>
                    Extra Mattresses
                </label>
                <input type="number" name="extra_mattress" class="modern-input" value="{{ day.extra_mattress }}" min="0" max="10">
                <p class="helper-text">Additional mattresses required</p>
            </div>
            
            <div class="modern-form-group">
                <div class="checkbox-group">
                    <input type="checkbox" name="is_hotel_booked" id="is_hotel_booked" {% if day.is_hotel_booked %}checked{% endif %}>
                    <label for="is_hotel_booked" class="modern-label">
                        <i class="bi bi-check-circle"></i>
                        Mark as Booked
                    </label>
                </div>
                <p class="helper-text">Check to confirm hotel booking and block dates</p>
            </div>
        </div>
        
        <!-- Hotel Availability Status -->
        {% if day.hotel and day.check_in_date and day.check_out_date %}
        <div id="hotel-availability" class="hotel-availability">
            <i class="bi bi-info-circle"></i> Hotel availability will be checked here
        </div>
        {% endif %}
    </div>
    
    <!-- Activities & Events -->
    <div class="form-section">
        <div class="section-title">
            <i class="bi bi-map"></i>
            Activities & Event Places
        </div>
        
        <div class="modern-form-group">
            <label class="modern-label">
                <i class="bi bi-list-check"></i>
                Activities & Places to Visit
            </label>
            <textarea name="activities" class="modern-textarea" placeholder="Enter activities, places to visit, and events for this day...">{{ day.activities }}</textarea>
            <p class="helper-text">List all activities, tourist places, and events planned for this day</p>
        </div>
        
        <!-- Quick Add Event Places -->
        <div class="form-grid">
            <div class="modern-form-group">
                <label class="modern-label">
                    <i class="bi bi-geo-alt"></i>
                    Quick Add Event Places
                </label>
                <select class="modern-select" id="quick-add-events">
                    <option value="">Select to add event place</option>
                    {% for event in event_places %}
                    <option value="{{ event.name }} - {{ event.location }} (Entry: ₹{{ event.entry_fee }})">
                        {{ event.name }} - ₹{{ event.entry_fee }}
                    </option>
                    {% endfor %}
                </select>
                <p class="helper-text">Select event places to quickly add to activities</p>
            </div>
        </div>
    </div>
    
    <!-- Transportation -->
    <div class="form-section">
        <div class="section-title">
            <i class="bi bi-truck"></i>
            Transportation Costs
        </div>
        
        <div class="form-grid-3">
            <div class="modern-form-group">
                <label class="modern-label">
                    <i class="bi bi-car-front"></i>
                    Cab Price
                </label>
                <input type="number" name="cab_price" class="modern-input" value="{{ day.cab_price }}" step="0.01" min="0">
                <p class="helper-text">Cab/vehicle cost for the day</p>
            </div>
            
            <div class="modern-form-group">
                <label class="modern-label">
                    <i class="bi bi-water"></i>
                    Ferry Price
                </label>
                <input type="number" name="ferry_price" class="modern-input" value="{{ day.ferry_price }}" step="0.01" min="0">
                <p class="helper-text">Ferry transportation cost</p>
            </div>
            
            <div class="modern-form-group">
                <label class="modern-label">
                    <i class="bi bi-speedometer2"></i>
                    Speedboat Price
                </label>
                <input type="number" name="speedboat_price" class="modern-input" value="{{ day.speedboat_price }}" step="0.01" min="0">
                <p class="helper-text">Speedboat/boat cost</p>
            </div>
        </div>
        
        <div class="form-grid-2">
            <div class="modern-form-group">
                <label class="modern-label">
                    <i class="bi bi-ticket-perforated"></i>
                    Entry Tickets
                </label>
                <input type="number" name="entry_tickets" class="modern-input" value="{{ day.entry_tickets }}" step="0.01" min="0">
                <p class="helper-text">Total entry ticket costs</p>
            </div>
            
            <div class="modern-form-group">
                <label class="modern-label">
                    <i class="bi bi-plus-circle"></i>
                    Additional Charges
                </label>
                <input type="number" name="additional_charges" class="modern-input" value="{{ day.additional_charges }}" step="0.01" min="0">
                <p class="helper-text">Any extra charges for this day</p>
            </div>
        </div>
        
        <div class="modern-form-group">
            <label class="modern-label">
                <i class="bi bi-chat-left-text"></i>
                Additional Charges Description
            </label>
            <textarea name="additional_charges_description" class="modern-textarea" placeholder="Describe what the additional charges are for...">{{ day.additional_charges_description }}</textarea>
        </div>
    </div>
    
    <!-- Cost Summary -->
    <div class="cost-summary">
        <h4><i class="bi bi-calculator"></i> Day Cost Summary</h4>
        <div class="cost-item">
            <span>Hotel Cost:</span>
            <span id="hotel-cost">₹0</span>
        </div>
        <div class="cost-item">
            <span>Transportation:</span>
            <span id="transport-cost">₹0</span>
        </div>
        <div class="cost-item">
            <span>Entry Tickets:</span>
            <span id="ticket-cost">₹0</span>
        </div>
        <div class="cost-item">
            <span>Additional Charges:</span>
            <span id="additional-cost">₹0</span>
        </div>
        <div class="cost-item cost-total">
            <span>Total Day Cost:</span>
            <span id="total-day-cost">₹0</span>
        </div>
    </div>
    
    <!-- Submit Button -->
    <div class="submit-section">
        <button type="submit" class="btn-submit-modern">
            <i class="bi bi-check-circle-fill"></i>
            Update Day {{ day.day_number }}
        </button>
        <br>
        <a href="{% url 'itinerary_detail' day.itinerary.id %}" class="btn-modern btn-secondary-modern mt-2">
            <i class="bi bi-arrow-left"></i>
            Back to Itinerary
        </a>
    </div>
</form>

<!-- JavaScript for dynamic functionality -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Hotel selection change handler
    const hotelSelect = document.getElementById('hotel-select');
    const roomCategorySelect = document.getElementById('room-category-select');
    
    hotelSelect.addEventListener('change', function() {
        const hotelId = this.value;
        roomCategorySelect.innerHTML = '<option value="">Choose Room Category</option>';
        
        if (hotelId) {
            // Fetch room categories for selected hotel
            fetch(`/inquiries/get-room-categories/${hotelId}/`)
                .then(response => response.json())
                .then(data => {
                    data.room_categories.forEach(room => {
                        const option = document.createElement('option');
                        option.value = room.id;
                        option.textContent = `${room.room_type} - ₹${room.price_per_night}/night`;
                        if ({{ day.room_category.id|default:'null' }} == room.id) {
                            option.selected = true;
                        }
                        roomCategorySelect.appendChild(option);
                    });
                    updateCosts();
                })
                .catch(error => console.error('Error:', error));
        }
    });
    
    // Quick add events handler
    const quickAddEvents = document.getElementById('quick-add-events');
    const activitiesTextarea = document.querySelector('textarea[name="activities"]');
    
    quickAddEvents.addEventListener('change', function() {
        if (this.value) {
            const currentActivities = activitiesTextarea.value;
            const newActivity = this.value;
            
            if (currentActivities) {
                activitiesTextarea.value = currentActivities + '\n• ' + newActivity;
            } else {
                activitiesTextarea.value = '• ' + newActivity;
            }
            
            this.value = ''; // Reset selection
        }
    });
    
    // Cost calculation function
    function updateCosts() {
        const roomCategorySelect = document.getElementById('room-category-select');
        const numberOfRooms = parseInt(document.querySelector('input[name="number_of_rooms"]').value) || 0;
        const extraMattress = parseInt(document.querySelector('input[name="extra_mattress"]').value) || 0;
        const cabPrice = parseFloat(document.querySelector('input[name="cab_price"]').value) || 0;
        const ferryPrice = parseFloat(document.querySelector('input[name="ferry_price"]').value) || 0;
        const speedboatPrice = parseFloat(document.querySelector('input[name="speedboat_price"]').value) || 0;
        const entryTickets = parseFloat(document.querySelector('input[name="entry_tickets"]').value) || 0;
        const additionalCharges = parseFloat(document.querySelector('input[name="additional_charges"]').value) || 0;
        
        // Calculate hotel cost
        let hotelCost = 0;
        if (roomCategorySelect.selectedIndex > 0) {
            const selectedOption = roomCategorySelect.options[roomCategorySelect.selectedIndex];
            const priceMatch = selectedOption.textContent.match(/₹(\d+)/);
            if (priceMatch) {
                const pricePerNight = parseFloat(priceMatch[1]);
                hotelCost = pricePerNight * numberOfRooms;
                // Add extra mattress cost (assuming ₹500 per mattress)
                hotelCost += extraMattress * 500;
            }
        }
        
        const transportCost = cabPrice + ferryPrice + speedboatPrice;
        const totalCost = hotelCost + transportCost + entryTickets + additionalCharges;
        
        // Update display
        document.getElementById('hotel-cost').textContent = '₹' + hotelCost.toFixed(2);
        document.getElementById('transport-cost').textContent = '₹' + transportCost.toFixed(2);
        document.getElementById('ticket-cost').textContent = '₹' + entryTickets.toFixed(2);
        document.getElementById('additional-cost').textContent = '₹' + additionalCharges.toFixed(2);
        document.getElementById('total-day-cost').textContent = '₹' + totalCost.toFixed(2);
    }
    
    // Add event listeners for cost updates
    const costInputs = document.querySelectorAll('input[name="number_of_rooms"], input[name="extra_mattress"], input[name="cab_price"], input[name="ferry_price"], input[name="speedboat_price"], input[name="entry_tickets"], input[name="additional_charges"]');
    costInputs.forEach(input => {
        input.addEventListener('input', updateCosts);
    });
    
    roomCategorySelect.addEventListener('change', updateCosts);
    
    // Initial cost calculation
    updateCosts();
    
    // Trigger hotel change if hotel is already selected
    if (hotelSelect.value) {
        hotelSelect.dispatchEvent(new Event('change'));
    }
});
</script>
{% endblock %}
